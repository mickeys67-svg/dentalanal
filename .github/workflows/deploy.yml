name: Deploy to Google Cloud Run

on:
  push:
    branches: [ main, master ]

env:
  PROJECT_ID: dentalanal
  REGION: us-west1
  REPO_NAME: dentalanal-repo

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev

      # Build and Push Backend
      - name: Build and Push Backend
        run: |
          docker build -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest ./backend
          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest

      # Deploy Backend
      - name: Deploy Backend to Cloud Run
        id: deploy_backend
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: dentalanal-backend
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/backend:latest
          region: ${{ env.REGION }}
          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            DATABASE_PASSWORD=${{ secrets.DATABASE_PASSWORD }}
            SUPABASE_URL=${{ secrets.SUPABASE_URL }}
            ADMIN_EMAIL=${{ secrets.ADMIN_EMAIL }}
            ADMIN_PASSWORD=${{ secrets.ADMIN_PASSWORD }}
            SECRET_KEY=${{ secrets.SECRET_KEY }}
            NAVER_AD_CUSTOMER_ID=${{ secrets.NAVER_AD_CUSTOMER_ID }}
            NAVER_AD_ACCESS_LICENSE=${{ secrets.NAVER_AD_ACCESS_LICENSE }}
            NAVER_AD_SECRET_KEY=${{ secrets.NAVER_AD_SECRET_KEY }}
            NAVER_CLIENT_ID=${{ secrets.NAVER_CLIENT_ID }}
            NAVER_CLIENT_SECRET=${{ secrets.NAVER_CLIENT_SECRET }}
            BRIGHT_DATA_CDP_URL=${{ secrets.BRIGHT_DATA_CDP_URL }}
          flags: "--allow-unauthenticated --port=8080 --cpu=1 --memory=2Gi --timeout=600"

      # [SECURITY FIX] Validate backend URL before using it in frontend build
      - name: Validate Backend Deployment URL
        run: |
          BACKEND_URL="${{ steps.deploy_backend.outputs.url }}"
          echo "Backend URL from outputs: [$BACKEND_URL]"

          if [ -z "$BACKEND_URL" ]; then
            echo "❌ CRITICAL: Backend deployment URL is empty!"
            echo "   The frontend will not be able to communicate with the backend."
            echo "   This usually means the backend deployment failed."
            echo "   Check the 'Deploy Backend to Cloud Run' step above for errors."
            exit 1
          fi

          if ! [[ "$BACKEND_URL" =~ ^https:// ]]; then
            echo "❌ CRITICAL: Backend URL does not start with https://"
            echo "   Expected format: https://service-xxxxx.region.run.app"
            echo "   Got: $BACKEND_URL"
            exit 1
          fi

          echo "✅ Backend URL is valid: $BACKEND_URL"

      # Build and Push Frontend (After Backend is deployed to get the URL)
      - name: Build and Push Frontend
        run: |
          BACKEND_URL="${{ steps.deploy_backend.outputs.url }}"
          echo "Building frontend with backend URL: $BACKEND_URL"

          docker build --build-arg NEXT_PUBLIC_API_URL=$BACKEND_URL \
            -t ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest \
            ./frontend

          docker push ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest

      # Deploy Frontend
      - name: Deploy Frontend to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: dentalanal
          image: ${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/${{ env.REPO_NAME }}/frontend:latest
          region: ${{ env.REGION }}
          env_vars: |
            NEXT_PUBLIC_API_URL=${{ steps.deploy_backend.outputs.url }}
          flags: "--allow-unauthenticated --port=8080"
